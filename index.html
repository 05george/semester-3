<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100vw;
  height: 100svh;
  overflow-x: auto;
  overflow-y: hidden;
  background: black;
}
body {
  display: block;
  width: auto;
  height: 100svh;
}

#main-svg {
  height: 100svh;
  display: block;
  background: black;
}

.image-mapper-shape {
  fill: transparent;
  stroke: yellow;
  stroke-width: 2px;
  transform-origin: center center;
  transition: transform 0.3s ease, filter 0.3s ease, stroke-width 0.3s ease;
}
.q { stroke: red; }
.v { stroke: blue; }
.ipc { stroke: white; }
.o { stroke: #80CBC4; }
.a { stroke: #F48FB1; }
.zoom-part {
  pointer-events: none;
  transition: transform 0.3s ease, filter 0.3s ease, opacity 0.3s ease;
  image-rendering: auto;
}
</style>
</head>
<body>
<svg xmlns="http://www.w3.org/2000/svg" id="main-svg" preserveAspectRatio="xMinYMin meet">
  <defs id="clip-defs"></defs>

  <!-- الصور مع مجموعات الـ g -->
  <g transform="translate(0,0)">
    <image x="0" y="0" xlink:href="image/1.png" width="1024" height="2454" />
    <g transform="translate(254,0)">
      <a href="cvs-physio-1.pdf"><rect x="0" y="423" width="114" height="467" class="image-mapper-shape"/></a>
      <a href="cvs-histo-1.pdf"><rect x="-1" y="1403" width="114" height="438" class="image-mapper-shape"/></a>
    </g>
    <g transform="translate(484,0)">
      <a href="cvs-physio-2.pdf"><rect x="0" y="314" width="113" height="459" class="image-mapper-shape"/></a>
    </g>
    <g transform="translate(488,0)">
      <a href="cvs-physio-3.pdf"><rect x="0" y="1838" width="108" height="441" class="image-mapper-shape"/></a>
    </g>
    <g transform="translate(599,0)">
      <a href="cvs-bio-1.pdf"><rect x="0" y="893" width="112" height="511" class="image-mapper-shape"/></a>
    </g>
  </g>

  <g transform="translate(1024,0)">
    <image x="0" y="0" xlink:href="image/2.png" width="1024" height="2454" />
  </g>

  <g transform="translate(2048,0)">
    <image x="0" y="0" xlink:href="image/3.png" width="1024" height="2454" />
  </g>

  <g transform="translate(3072,0)">
    <image x="0" y="0" xlink:href="image/4.png" width="1024" height="2454" />
  </g>

  <g transform="translate(4096,0)">
    <image x="0" y="0" xlink:href="image/5.png" width="1024" height="2454" />
  </g>

  <g transform="translate(5120,0)">
    <image x="0" y="0" xlink:href="image/6.png" width="1024" height="2454" />
  </g>

  <g transform="translate(6144,0)">
    <image x="0" y="0" xlink:href="image/7.png" width="1024" height="2454" />
  </g>

  <g transform="translate(7168,0)">
    <image x="0" y="0" xlink:href="image/8.png" width="1024" height="2454" />
  </g>

  <g transform="translate(8192,0)">
    <image x="0" y="0" xlink:href="image/9.png" width="1024" height="2454" />
  </g>

  <g transform="translate(9216,0)">
    <image x="0" y="0" xlink:href="image/10.png" width="1024" height="2454" />
  </g>

  <g transform="translate(10240,0)">
    <image x="0" y="0" xlink:href="image/11.png" width="1024" height="2454" />
  </g>

</svg>

<script>
const mainSvg = document.getElementById('main-svg');
const clipDefs = document.getElementById('clip-defs');
const activeState = { rect: null, zoomPart: null, animationId: null, clipPathId: null };

// ضبط العرض ديناميكي حسب عدد الصور
function setDynamicSvgWidth() {
  const imageGroups = mainSvg.querySelectorAll('g > image');
  const IMAGE_WIDTH = 1024;
  const IMAGE_HEIGHT = 2454;
  const totalWidth = imageGroups.length * IMAGE_WIDTH;
  mainSvg.style.width = `${totalWidth}px`;
  mainSvg.setAttribute('viewBox', `0 0 ${totalWidth} ${IMAGE_HEIGHT}`);
}
setDynamicSvgWidth();

// دوال مساعدة للحصول على إحداثيات
function getTransformX(groupElement) {
  if (!groupElement) return 0;
  const transformAttr = groupElement.getAttribute('transform');
  if (!transformAttr) return 0;
  const match = transformAttr.match(/translate\(([\d\.-]+),\s*([\d\.-]+)\)/);
  return match ? parseFloat(match[1]) : 0;
}
function getTransformY(groupElement) {
  if (!groupElement) return 0;
  const transformAttr = groupElement.getAttribute('transform');
  if (!transformAttr) return 0;
  const match = transformAttr.match(/translate\(([\d\.-]+),\s*([\d\.-]+)\)/);
  return match ? parseFloat(match[2]) : 0;
}
function getGroupImage(parentGroup) {
  const baseImage = parentGroup.querySelector('image');
  if (!baseImage) return null;
  const IMAGE_SRC = baseImage.getAttribute('href') || baseImage.getAttribute('xlink:href');
  const IMAGE_WIDTH = parseFloat(baseImage.getAttribute('width'));
  const IMAGE_HEIGHT = parseFloat(baseImage.getAttribute('height'));
  if (isNaN(IMAGE_WIDTH) || isNaN(IMAGE_HEIGHT)) return null;
  return { src: IMAGE_SRC, width: IMAGE_WIDTH, height: IMAGE_HEIGHT };
}

// تنظيف تأثير hover
function cleanupHover() {
  if (!activeState.rect) return;
  if(activeState.animationId) clearInterval(activeState.animationId);
  activeState.rect.style.transform = 'scale(1)';
  activeState.rect.style.filter = 'none';
  activeState.rect.style.strokeWidth = '2px';
  if(activeState.zoomPart){ activeState.zoomPart.remove(); }
  const currentClip = document.getElementById(activeState.clipPathId);
  if(currentClip) currentClip.remove();
  activeState.rect = null;
  activeState.zoomPart = null;
  activeState.animationId = null;
  activeState.clipPathId = null;
}

// تطبيق hover على المستطيلات
function attachHover(rect, i) {
  const clipPathId = `clip-${i}-${Date.now()}`;
  const scale = 1.1;
  rect.setAttribute('data-index', i);
  rect.addEventListener('mouseover', startHover);
  rect.addEventListener('mouseout', stopHover);
  rect.addEventListener('touchstart', startHover);
  rect.addEventListener('touchend', cleanupHover);

  function startHover() {
    if(activeState.rect === rect) return;
    cleanupHover();
    activeState.rect = rect;
    activeState.clipPathId = clipPathId;

    const x = parseFloat(rect.getAttribute('x'));
    const y = parseFloat(rect.getAttribute('y'));
    const width = parseFloat(rect.getAttribute('width'));
    const height = parseFloat(rect.getAttribute('height'));

    const dayGroup = rect.closest('g');
    const weekGroup = rect.closest('svg > g');

    const imageData = getGroupImage(weekGroup);
    if (!imageData) return;

    const weekOffsetX = getTransformX(weekGroup);
    const dayOffsetX = getTransformX(dayGroup);
    const weekOffsetY = getTransformY(weekGroup);
    const dayOffsetY = getTransformY(dayGroup);
    const absoluteX = x + weekOffsetX + dayOffsetX;
    const absoluteY = y + weekOffsetY + dayOffsetY;

    let clip = document.createElementNS('http://www.w3.org/2000/svg','clipPath');
    clip.setAttribute('id', clipPathId);
    let clipRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    clipRect.setAttribute('x', absoluteX);
    clipRect.setAttribute('y', absoluteY);
    clipRect.setAttribute('width', width);
    clipRect.setAttribute('height', height);
    clipDefs.appendChild(clip).appendChild(clipRect);

    const zoomPart = document.createElementNS('http://www.w3.org/2000/svg','image');
    zoomPart.setAttribute('href', imageData.src);
    zoomPart.setAttribute('width', imageData.width);
    zoomPart.setAttribute('height', imageData.height);
    zoomPart.setAttribute('class','zoom-part');
    zoomPart.setAttribute('clip-path', `url(#${clipPathId})`);

    zoomPart.setAttribute('x', weekOffsetX);
    zoomPart.setAttribute('y', weekOffsetY);

    zoomPart.style.transformOrigin = `${absoluteX + width/2}px ${absoluteY + height/2}px`;
    zoomPart.style.opacity = 0;
    mainSvg.appendChild(zoomPart);
    activeState.zoomPart = zoomPart;

    rect.style.transformOrigin = `${x + width/2}px ${y + height/2}px`;
    rect.style.transform = `scale(${scale})`;
    rect.style.strokeWidth = '4px';

    zoomPart.style.transform = `scale(${scale})`;
    zoomPart.style.opacity = 1;

    // تأثير Glow
    let hue = 0;
    let currentStrokeWidth = 4;
    const animationId = setInterval(() => {
      hue = (hue + 1) % 360;
      const glow = `drop-shadow(0 0 8px hsl(${hue},100%,55%)) drop-shadow(0 0 14px hsl(${(hue+60)%360},100%,60%))`;
      rect.style.filter = glow;
      if(zoomPart) zoomPart.style.filter = glow;

      currentStrokeWidth = (currentStrokeWidth === 4) ? 3.5 : 4;
      rect.style.strokeWidth = `${currentStrokeWidth}px`;

    }, 100);
    activeState.animationId = animationId;
  }

  function stopHover(e) {
    const targetRect = e ? (e.target.tagName === 'rect' ? e.target : e.target.closest('a')?.querySelector('.image-mapper-shape')) : rect;
    if(targetRect === activeState.rect && e.type === 'mouseout'){
      cleanupHover();
    }
  }
}

// تطبيق hover على كل المستطيلات
document.querySelectorAll('rect.image-mapper-shape').forEach((rect, i) => {
  rect.setAttribute('data-processed', 'true');
  attachHover(rect, i);
});

// مراقبة التعديلات الجديدة
const rootObserver = new MutationObserver(() => {
  document.querySelectorAll('rect.image-mapper-shape:not([data-processed])')
    .forEach((rect, i) => {
      rect.setAttribute('data-processed', 'true');
      attachHover(rect, i);
    });
});
rootObserver.observe(mainSvg, { childList: true, subtree: true });

// ضبط فتح الروابط حسب الموبايل
function setLinkTarget() {
  const isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0) || (window.innerWidth < 800);
  const allLinks = document.querySelectorAll('a[xlink\\:href], a[href]');
  allLinks.forEach(link => {
    if (isMobile) { link.removeAttribute('target'); }
    else { link.setAttribute('target', '_blank'); }
  });
}
setLinkTarget();
</script>
</body>
</html>